Bootstrap: docker
From: ubuntu

%post
    # Install necessary system packages
    apt-get update && apt-get install -y python3 python3-pip vim git bash parallel wget curl locales libgl1 python3-openpyxl python3-packaging libglx-mesa0 libglib2.0-0 git-lfs jq libgfortran5 libatlas3-base bc python-is-python3 libxt6 libeigen3-dev zlib1g-dev libgl1-mesa-dev libtiff5-dev libfftw3-dev libxft2 libxpm4 libgomp1 libxrender1 cmake g++ make software-properties-common ca-certificates libglu1-mesa libsm6 libice6 libpng16-16 libxcursor1 libxinerama1 libfreetype6 libxrandr2 libgtk2.0-0 libpulse0 libcaca0 bzip2 dc    
    
    mkdir -p /usr/local/lib/python3.12/dist-packages/afni/
    cd /usr/local/lib/python3.12/dist-packages/afni/
    curl -O https://afni.nimh.nih.gov/pub/dist/tgz/linux_ubuntu_16_64.tgz
    tar -xzf linux_ubuntu_16_64.tgz

    mkdir -p /usr/local/lib/python3.12/dist-packages/fsl/ 
    cd /usr/local/lib/python3.12/dist-packages/fsl/ 
    curl -O https://fsl.fmrib.ox.ac.uk/fsldownloads/fsl-5.0.11-centos6_64.tar.gz 
    tar -xzvf fsl-5.0.11-centos6_64.tar.gz

    # Install Python packages using pip
    pip install --break-system-packages pybids
    pip install --break-system-packages bids
    pip install --break-system-packages nibabel==3.2.1
    pip install --break-system-packages pydicom>=1.3.0
    pip install --break-system-packages setuptools
    pip install --break-system-packages wheel
    pip install --break-system-packages pyyaml && pip install --break-system-packages 'numpy<2.0.0'
    pip install --break-system-packages backends==1.6.6
    pip install --break-system-packages scipy>=1.2.1 
    pip install --break-system-packages scikit-learn>=0.20.3
    pip install --break-system-packages matplotlib>=3.0.3
    pip install --break-system-packages statsmodels>=0.9.0
    pip install --break-system-packages patsy>=0.5.1
    pip install --break-system-packages pandas>=1.1.5
    pip install --break-system-packages scikit-image
    pip install --break-system-packages dipy==1.8.0
    pip install --break-system-packages absl-py    
    pip install --upgrade --force-reinstall --index-url https://__token__:glpat-NzRyYs9NWyXtWDCWJLif@gitlab.com/api/v4/projects/65904707/packages/pypi/simple Diciphr --no-deps --break-system-packages
    
    mkdir -p /usr/local/bin/Scripts
    mkdir -p /usr/local/Input
    chmod +x /usr/local/bin/Scripts/*.sh

    # Find installation paths
    NUMPY_PATH=$(python3 -c 'import numpy; print(numpy.__path__[0])')
    SCIPY_PATH=$(python3 -c 'import scipy; print(scipy.__path__[0])')
    NIBABEL_PATH=$(python3 -c 'import nibabel; print(nibabel.__path__[0])')
    SKLEARN_PATH=$(python3 -c 'import sklearn; print(sklearn.__path__[0])')
    MATPLOTLIB_PATH=$(python3 -c 'import matplotlib; print(matplotlib.__path__[0])')
    STATSMODELS_PATH=$(python3 -c 'import statsmodels; print(statsmodels.__path__[0])')
    PATSY_PATH=$(python3 -c 'import patsy; print(patsy.__path__[0])')
    PANDAS_PATH=$(python3 -c 'import pandas; print(pandas.__path__[0])')
    PYDICOM_PATH=$(python3 -c 'import pydicom; print(pydicom.__path__[0])')
    DIPY_PATH=$(python3 -c 'import dipy; print(dipy.__path__[0])')
    DICIPHR_PATH=$(python3 -c 'import diciphr; print(diciphr.__path__[0])')

    echo $DICIPHR_PATH
    echo $DIPY_PATH
    mkdir -p /usr/local/Modules/modulefiles
    mkdir -p /usr/local/Modules/modulefiles/Brainmage
    mkdir -p /usr/local/Input/EveTemplate
    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8    
    git clone https://github.com/CBICA/BrainMaGe.git /usr/local/Modules/modulefiles/Brainmage
    cd /usr/local/Modules/modulefiles/Brainmage
    git-lfs install
    git lfs pull
    python3 -c "import yaml; f = open('requirements.yml', 'r'); requirements = yaml.safe_load(f); f.close(); f = open('requirements.txt', 'w'); [f.write(dep + '\n') for dep in requirements['dependencies'] if isinstance(dep, str) and '::' not in dep and '=' not in dep and not any(pkg in dep for pkg in ['absl-py', 'grpcio', 'scikit-image'])]; [f.write(pip_dep + '\n') for dep in requirements['dependencies'] if isinstance(dep, dict) and 'pip' in dep for pip_dep in dep['pip'] if not any(pkg in pip_dep for pkg in ['absl-py', 'grpcio', 'nibabel', 'pybids', 'scikit-image'])]; f.close()"
    python3 --version
    while IFS= read -r package; do
        pip install "$package" --break-system-packages || echo "Failed to install $package, continuing..."
    done < requirements.txt
    latesttag=$(git describe --tags)

    pip uninstall --break-system-packages -y nibabel
    pip uninstall --break-system-packages -y pydicom
    pip install --break-system-packages 'pydicom<=1.4.1'
    pip install --break-system-packages nibabel==3.2.1
    pip install --break-system-packages itk
    pip uninstall --break-system-packages -y pytorch-lightning
    pip install --break-system-packages pytorch-lightning==0.7.6
    pip uninstall --break-system-packages -y torchmetrics
    pip install --break-system-packages torchmetrics==0.11.4
    pip uninstall --break-system-packages -y tensorboard
    pip install --break-system-packages tensorboard==2.18.0
    
    echo checking out ${latesttag}
    git checkout ${latesttag}
    python3 setup.py install --single-version-externally-managed --record record.txt    
    chmod -R +x /usr/local/lib/python3.12/dist-packages/diciphr
    ls -R /usr/local/lib/python3.12/dist-packages/diciphr
    rm /usr/local/Modules/modulefiles/Brainmage/BrainMaGe.egg-info/requires.txt
    python3 -m pip list -v    
    mkdir -p /usr/BrainMaGe/weights/
    cp /usr/local/lib/python3.12/dist-packages/BrainMaGe/weights/resunet_ma.pt /usr/BrainMaGe/weights/
    chmod -R +x /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/
    chmod -R +x /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/lib/
    chmod -R +x /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/
    chmod -R +x /usr/local/Modules/modulefiles/Brainmage/brain_mage_run
    chmod -R +x /usr/local/Modules/modulefiles/Brainmage/brain_mage_single_run

%files
    # Include your scripts
    ./DiCIPHR-Pipeline/Scripts/Fernet.sh /usr/local/bin/Scripts/Fernet.sh
    ./DiCIPHR-Pipeline/Scripts/brainmage.sh /usr/local/bin/Scripts/brainmage.sh
    ./DiCIPHR-Pipeline/Scripts/DTI_Preprocess.sh /usr/local/bin/Scripts/DTI_Preprocess.sh
    ./DiCIPHR-Pipeline/Scripts/Registration_T1-Eve.sh /usr/local/bin/Scripts/Registration_T1-Eve.sh
    ./DiCIPHR-Pipeline/Scripts/Registration_DTI-T1.sh /usr/local/bin/Scripts/Registration_DTI-T1.sh
    ./DiCIPHR-Pipeline/Scripts/Registration_DTI-Eve.sh /usr/local/bin/Scripts/Registration_DTI-Eve.sh
    ./DiCIPHR-Pipeline/Scripts/roi_stats.py /usr/local/bin/Scripts/roi_stats.py
    ./DiCIPHR-Pipeline/Scripts/pipeline_utils.sh /usr/local/bin/Scripts/pipeline_utils.sh
    ./DiCIPHR-Pipeline/Scripts/patch_numpy.py /usr/local/bin/Scripts/patch_numpy.py

    # Copy Data Files into the container
    /usr/lib64/libXp.so.6 /usr/local/lib64/libXp.so.6
    /usr/lib64/libXmu.so.6 /usr/local/lib64/libXmu.so.6
    /usr/lib64/libpng12.so.0 /usr/local/lib64/libpng12.so.0
    ./DiCIPHR-Pipeline/Input/EveTemplate /usr/local/Input/EveTemplate    
    ./DiCIPHR-Pipeline/Input/brainmage/sri24_atlas.nii.gz /usr/local/Input/sri24_atlas.nii.gz
    /cbica/software/external/ANTs/centos7/2.3.1/lib/libl_ResampleImage.so.2 /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/lib/libl_ResampleImage.so.2
    /cbica/software/external/ANTs/centos7/2.3.1/bin/antsRegistrationSyN.sh /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/antsRegistrationSyN.sh
    /cbica/software/external/ants/centos7/2.3.1/lib/libl_N4BiasFieldCorrection.so.2 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/lib/libl_N4BiasFieldCorrection.so.2
    /cbica/software/external/ANTs/centos7/2.3.1/bin/ResampleImage /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/ResampleImage
    /cbica/software/external/ANTs/centos7/2.3.1/bin/N4BiasFieldCorrection /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/N4BiasFieldCorrection
    /cbica/software/external/ANTs/centos7/2.3.1/bin/antsApplyTransforms /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/antsApplyTransforms
    /cbica/software/external/ANTs/centos7/2.3.1/bin/antsRegistrationSyNQuick.sh /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/antsRegistrationSyNQuick.sh
    /cbica/software/external/ANTs/centos7/2.3.1/bin/antsRegistration /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/antsRegistration
    /cbica/software/external/ANTs/centos7/2.3.1/bin/antsApplyTransforms /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/antsApplyTransforms
    /cbica/software/external/ANTs/centos7/2.3.1/bin /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin
    /cbica/software/external/ants/centos7/2.3.1/lib/libl_antsApplyTransforms.so.2 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/lib/libl_antsApplyTransforms.so.2
    /cbica/software/external/ANTs/centos7/2.3.1/bin/PrintHeader /usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/PrintHeader
    /cbica/software/external/ants/centos7/2.3.1/lib/libl_PrintHeader.so.2 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/lib/libl_PrintHeader.so.2    
    /cbica/software/external/ants/centos7/2.3.1/lib/libl_antsRegistration.so.2 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/lib/libl_antsRegistration.so.2
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKDICOMParser-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKDICOMParser-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOBruker-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOBruker-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOCSV-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOCSV-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOHDF5-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOHDF5-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitktiff-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitktiff-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkjpeg-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkjpeg-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOLSM-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOLSM-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMINC-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMINC-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkminc2-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkminc2-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMRC-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMRC-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMesh-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMesh-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKgiftiio-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKgiftiio-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKniftiio-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKniftiio-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKznz-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKznz-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMeshBYU-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMeshBYU-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMeshVTK-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMeshVTK-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMeshBase-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMeshBase-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKNrrdIO-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKNrrdIO-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkpng-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkpng-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKOptimizersv4-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKOptimizersv4-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitklbfgs-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitklbfgs-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKReview-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKReview-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKLabelMap-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKLabelMap-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKQuadEdgeMesh-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKQuadEdgeMesh-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKOptimizers-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKOptimizers-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKPolynomials-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKPolynomials-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKBiasCorrection-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKBiasCorrection-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOBMP-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOBMP-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOBioRad-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOBioRad-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOGDCM-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOGDCM-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmMSFF-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmMSFF-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmDICT-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmDICT-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmIOD-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmIOD-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmDSED-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmDSED-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmCommon-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmCommon-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOGE-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOGE-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOIPL-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOIPL-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOGIPL-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOGIPL-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOJPEG-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOJPEG-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTIFF-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTIFF-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMeta-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOMeta-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKMetaIO-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKMetaIO-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIONIFTI-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIONIFTI-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIONRRD-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIONRRD-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOPNG-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOPNG-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOSiemens-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOSiemens-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOXML-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOXML-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKEXPAT-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKEXPAT-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOSpatialObjects-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOSpatialObjects-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOStimulate-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOStimulate-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTransformHDF5-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTransformHDF5-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkhdf5_cpp.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkhdf5_cpp.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkhdf5.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkhdf5.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTransformInsightLegacy-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTransformInsightLegacy-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTransformMatlab-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTransformMatlab-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTransformBase-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOTransformBase-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKTransformFactory-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKTransformFactory-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOVTK-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOVTK-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKKLMRegionGrowing-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKKLMRegionGrowing-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkopenjpeg-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkopenjpeg-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKVTK-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKVTK-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKWatersheds-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKWatersheds-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKStatistics-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKStatistics-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkNetlibSlatec-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkNetlibSlatec-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKSpatialObjects-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKSpatialObjects-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKTransform-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKTransform-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKMesh-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKMesh-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKPath-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKPath-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKVideoIO-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKVideoIO-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKVideoCore-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKVideoCore-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkMGHIO-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkMGHIO-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkzlib-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkzlib-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOImageBase-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKIOImageBase-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKCommon-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKCommon-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkdouble-conversion-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkdouble-conversion-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitksys-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitksys-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libITKVNLInstantiation-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libITKVNLInstantiation-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkvnl_algo-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkvnl_algo-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkvnl-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkvnl-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkv3p_netlib-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkv3p_netlib-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitknetlib-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitknetlib-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkvcl-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkvcl-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmjpeg8-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmjpeg8-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmjpeg12-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmjpeg12-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmjpeg16-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmjpeg16-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmopenjp2-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmopenjp2-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmcharls-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmcharls-5.0.so.1
    /cbica/software/external/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmuuid-5.0.so.1 /usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/libitkgdcmuuid-5.0.so.1

%environment
    # Set environment variables, if needed
    export PROJECT_DIR=/usr/local
    export DICIPHR=/usr/local/lib/python3.12/dist-packages/diciphr
    export FSLOUTPUTTYPE=NIFTI_GZ
    export LANG=en_US.UTF-8 
    export LC_ALL=en_US.UTF-8
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib64/
    export PYTHONPATH=${PYTHONPATH}:/usr/local/bin/Scripts
    export PYTHONPATH=${PYTHONPATH}:/usr/local/lib/python3.12/dist-packages/diciphr/utils.py
    export PYTHONPATH=${PYTHONPATH}:/usr/local/lib/python3.12/dist-packages/fsl/centos7/5.0.11/bin/
    export FSLDIR=/usr/local/lib/python3.12/dist-packages/fsl/fsl
    . ${FSLDIR}/etc/fslconf/fsl.sh
    export PATH=${FSLDIR}/bin:$PATH
    export PATH=/usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin:$PATH
    export PATH=/usr/local/lib/python3.12/dist-packages/afni/linux_ubuntu_16_64:$PATH
    export SINGULARITY_BINDPATH=/gs3,/gs4,/gs5,/gs6,/gs7,/gs8,/gs9,/gs10,/gs11,/spin1,/scratch,/fdb,/data,/lscratch    
    export ANTSPATH=/usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin
    export PATH=${ANTSPATH}:$PATH
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/lib
    export PYTHONPATH=${PYTHONPATH}:/usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/lib/
    export PYTHONPATH=${PYTHONPATH}:/usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/bin/
    export PYTHONPATH=${PYTHONPATH}:/usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib/python3.12/dist-packages/ants/centos7/2.3.1/ITKv5-install/lib/
    export PYTHONPATH=${PYTHONPATH}:/usr/local/Modules/modulefiles/Brainmage
    export PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
    export PYTHONPATH=${PYTHONPATH}:/usr/BrainMaGe/weights/resunet_ma.pt
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib/python3.12/dist-packages/ANTs/centos7/2.3.1/lib/
    
%runscript
    #!/bin/bash
    INPUT_SUBJECT=""
    INPUT_T1_BRAINMAGE=""
    INPUT_DTI_PREPROCESS_1=""
    INPUT_OPTIONAL_DTI_TOPUP=""
    INPUT_DTI_OUTDIR=""
    INPUT_DTI_PE_DIR=""
    INPUT_ATLAS=""
    INPUT_DTI_READ_TIME=""
    INPUT_WORKDIR=""

    # Parse command-line arguments 
    while getopts "s:i:d:t:o:p:a:T:w:m:" opt; do 
        case ${opt} in 
            s ) INPUT_SUBJECT="$OPTARG" ;; 
            i ) INPUT_T1_BRAINMAGE="$OPTARG" ;; 
            d ) INPUT_DTI_PREPROCESS_1="$OPTARG" ;; 
            t ) INPUT_OPTIONAL_DTI_TOPUP="$OPTARG" ;;
            o ) INPUT_DTI_OUTDIR="$OPTARG" ;;
            p ) INPUT_DTI_PE_DIR="$OPTARG" ;;
            a ) INPUT_ATLAS="$OPTARG" ;;
            T ) INPUT_DTI_READ_TIME="$OPTARG" ;;
            w ) INPUT_WORKDIR=$PWD ;;  
            m ) INPUT_MASK="OPTARG" ;;    
            \? ) echo "Usage: cmd [-s INPUT_SUBJECT] [-i INPUT_T1_BRAINMAGE] [-d INPUT_DTI_PREPROCESS_1] [-t INPUT_OPTIONAL_DTI_TOPUP] [-o INPUT_DTI_OUTDIR] [-p INPUT_DTI_PE_DIR] [-w INPUT_WORKDIR] [-a INPUT_ATLAS] [-T INPUT_DTI_READ_TIME] [-m INPUT_MASK]" 
            exit 1 ;; 
        esac 
    done

    # Check if mandatory arguments are provided 
    if [ -z "$INPUT_SUBJECT" ] || [ -z "$INPUT_T1_BRAINMAGE" ] || [ -z "$INPUT_DTI_PREPROCESS_1" ] || [ -z "$INPUT_DTI_OUTDIR" ]; then 
        echo "Error: Missing required arguments" 
        echo "Usage: singularity run diciphr_pipeline.sif -s <INPUT_SUBJECT> -i <INPUT_T1_BRAINMAGE> -d <INPUT_DTI_PREPROCESS_1> -o < INPUT_DTI_OUTDIR> [-t INPUT_OPTIONAL_DTI_TOPUP] [-p INPUT_DTI_PE_DIR] [-T INPUT_DTI_READ_TIME]" 
        exit 1
    fi  
  
    echo "Making Output Directories"
    mkdir -p $INPUT_DTI_OUTDIR/output/Output/brainmage/${INPUT_SUBJECT}
    mkdir -p $INPUT_DTI_OUTDIR/output/Output/Registration/
    mkdir -p $INPUT_DTI_OUTDIR/output/Output/Fernet/${INPUT_SUBJECT}
    mkdir -p $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT}
    mkdir -p $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_T1-Eve/${INPUT_SUBJECT}
    mkdir -p $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-T1/${INPUT_SUBJECT}
    mkdir -p $INPUT_DTI_OUTDIR/output/Output/Output_Temp_Dir
    mkdir -p $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT}
    mkdir -p $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT} 
    echo "Appending Diciphr Package to system path"
    OUTPUT_TEMP_DIR=$INPUT_DTI_OUTDIR/output/Output/Output_Temp_Dir
    
    TMPDIR=/tmp/$SLURM_JOB_ID
    mkdir -p $TMPDIR
    workdir=$(mktemp -d -p $TMPDIR tmpdir.XXXXXX)
    mkdir -p /tmp/brainmage
        
    echo "Running reorient_nifti.py file"
    python3 /usr/local/lib/python3.12/dist-packages/diciphr/scripts/reorient_nifti.py -i $INPUT_T1_BRAINMAGE -o $INPUT_T1_BRAINMAGE -r LPS
    python3 /usr/local/lib/python3.12/dist-packages/diciphr/scripts/reorient_nifti.py -i $INPUT_DTI_PREPROCESS_1 -o $INPUT_DTI_PREPROCESS_1 -r LPS
    
    echo "Running Brainmage"
    
    python3 /usr/local/bin/Scripts/patch_numpy.py
  
    /usr/local/bin/Scripts/brainmage.sh -s $INPUT_SUBJECT -i $INPUT_T1_BRAINMAGE -o $INPUT_DTI_OUTDIR/output/Output/brainmage/${INPUT_SUBJECT}/

    if [[ -f "$INPUT_DTI_OUTDIR/output/Output/brainmage/${INPUT_SUBJECT}/${INPUT_SUBJECT}_t1_brain.nii" ]] || [[ -f "$INPUT_DTI_OUTDIR/output/Output/brainmage/${INPUT_SUBJECT}_t1_brain.nii" ]]; then
        mv $INPUT_DTI_OUTDIR/output/Output/brainmage/${INPUT_SUBJECT}_t1_brain.nii.gz $OUTPUT_TEMP_DIR/${INPUT_SUBJECT}_t1_brain.nii.gz
        echo "File moved to temporary directory - output path provided"
    fi
    
    STATUS_BRAINMAGE=$?    
    
    if [ -n "$INPUT_OPTIONAL_DTI_TOPUP" ] || [ -n "$INPUT_DTI_PE_DIR" ]; then
        /usr/local/bin/Scripts/DTI_Preprocess.sh -s $INPUT_SUBJECT -d $INPUT_DTI_PREPROCESS_1 -o $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT} -t $INPUT_OPTIONAL_DTI_TOPUP -p $INPUT_DTI_PE_DIR -T $INPUT_DTI_READ_TIME -w $INPUT_WORKDIR
    else
        /usr/local/bin/Scripts/DTI_Preprocess.sh -s $INPUT_SUBJECT -d $INPUT_DTI_PREPROCESS_1 -o $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT} -w $INPUT_WORKDIR
    fi
        
    STATUS_DTI_PREPROCESS=$?

    echo "Registration part of pipeline"
    
    cp -r $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT}/* $OUTPUT_TEMP_DIR/
    cp -r $INPUT_DTI_OUTDIR/output/Output/brainmage/${INPUT_SUBJECT}/* $OUTPUT_TEMP_DIR/
    
    # If brainmage.sh was successful, run Registration part of pipeline 
    if [ "$STATUS_BRAINMAGE" -eq 0 ]; then 
        /usr/local/bin/Scripts/Registration_T1-Eve.sh -s $INPUT_SUBJECT -t $OUTPUT_TEMP_DIR/${INPUT_SUBJECT}_t1_brain.nii* -o $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_T1-Eve/${INPUT_SUBJECT} -w $INPUT_WORKDIR &
        /usr/local/bin/Scripts/Registration_DTI-T1.sh -s $INPUT_SUBJECT -t $OUTPUT_TEMP_DIR/${INPUT_SUBJECT}_t1_brain.nii* -d $INPUT_DTI_PREPROCESS_1 -o $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-T1/${INPUT_SUBJECT} -w $INPUT_WORKDIR &
    
    fi
    
    wait
        
    /usr/local/bin/Scripts/Fernet.sh -s $INPUT_SUBJECT -o $INPUT_DTI_OUTDIR/output/Output/Fernet/${INPUT_SUBJECT} -d $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT}/${INPUT_SUBJECT}_DWI_preprocessed.nii.gz -m $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT}/${INPUT_SUBJECT}_tensor_mask.nii.gz

    /usr/local/bin/Scripts/Registration_DTI-Eve.sh -s $INPUT_SUBJECT -o $INPUT_DTI_OUTDIR/output/Output/Registration -d $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT} -f $INPUT_DTI_OUTDIR/output/Output/Fernet/${INPUT_SUBJECT}
                
        # 8times roi_stats.py code
        # FA
    python3 /usr/local/bin/Scripts/roi_stats.py -s ${INPUT_SUBJECT} -a $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT}/${INPUT_SUBJECT}_Eve_Labels_to_DTI.nii* -f $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT}/${INPUT_SUBJECT}_tensor_FA.nii* -c FA -o $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT} -l /usr/local/Input/EveTemplate/JhuMniSSLabelLookupTable_1.csv -m mean median std
        
        # TR
    python3 /usr/local/bin/Scripts/roi_stats.py -s ${INPUT_SUBJECT} -a $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT}/${INPUT_SUBJECT}_Eve_Labels_to_DTI.nii* -f $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT}/${INPUT_SUBJECT}_tensor_TR.nii* -c TR -o $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT} -l /usr/local/Input/EveTemplate/JhuMniSSLabelLookupTable_1.csv -m mean median std

        # AX
    python3 /usr/local/bin/Scripts/roi_stats.py -s ${INPUT_SUBJECT} -a $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT}/${INPUT_SUBJECT}_Eve_Labels_to_DTI.nii* -f $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT}/${INPUT_SUBJECT}_tensor_AX.nii* -c AX -o $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT} -l /usr/local/Input/EveTemplate/JhuMniSSLabelLookupTable_1.csv -m mean median std
        
        # RAD
    python3 /usr/local/bin/Scripts/roi_stats.py -s ${INPUT_SUBJECT} -a $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT}/${INPUT_SUBJECT}_Eve_Labels_to_DTI.nii* -f $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT}/${INPUT_SUBJECT}_tensor_RAD.nii* -c RAD -o $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT} -l /usr/local/Input/EveTemplate/JhuMniSSLabelLookupTable_1.csv -m mean median std
        
        # FERNET
        # fwFA
    python3 /usr/local/bin/Scripts/roi_stats.py -s ${INPUT_SUBJECT} -a $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT}/${INPUT_SUBJECT}_Eve_Labels_to_DTI.nii* -f $INPUT_DTI_OUTDIR/output/Output/Fernet/${INPUT_SUBJECT}/${INPUT_SUBJECT}_fw_tensor_FA.nii* -c fwFA -o $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT} -l /usr/local/Input/EveTemplate/JhuMniSSLabelLookupTable_1.csv -m mean median std

        # fwVF
    python3 /usr/local/bin/Scripts/roi_stats.py -s ${INPUT_SUBJECT} -a $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT}/${INPUT_SUBJECT}_Eve_Labels_to_DTI.nii* -f $INPUT_DTI_OUTDIR/output/Output/Fernet/${INPUT_SUBJECT}/${INPUT_SUBJECT}_fw_volume_fraction.nii* -c fwVF -o $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT} -l /usr/local/Input/EveTemplate/JhuMniSSLabelLookupTable_1.csv -m mean median std

	#f
    python3 /usr/local/bin/Scripts/roi_stats.py -s ${INPUT_SUBJECT} -a $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT}/${INPUT_SUBJECT}_Eve_Labels_to_DTI.nii* -f $INPUT_DTI_OUTDIR/output/Output/Fernet/${INPUT_SUBJECT}/${INPUT_SUBJECT}_fw_tensor_AX.nii* -c fwAX -o $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT} -l /usr/local/Input/EveTemplate/JhuMniSSLabelLookupTable_1.csv -m mean median std

        # fwRAD
    python3 /usr/local/bin/Scripts/roi_stats.py -s ${INPUT_SUBJECT} -a $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT}/${INPUT_SUBJECT}_Eve_Labels_to_DTI.nii* -f $INPUT_DTI_OUTDIR/output/Output/Fernet/${INPUT_SUBJECT}/${INPUT_SUBJECT}_fw_tensor_RAD.nii* -c fwRAD -o $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT} -l /usr/local/Input/EveTemplate/JhuMniSSLabelLookupTable_1.csv -m mean median std
  
    mkdir -p $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/roi_stats/
    mv $INPUT_DTI_OUTDIR/output/Output/roi_stats/${INPUT_SUBJECT}/* $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/roi_stats/

    mkdir -p $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/brainmage/
    mv $INPUT_DTI_OUTDIR/output/Output/brainmage/${INPUT_SUBJECT}/* $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/brainmage/

    mkdir -p $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Fernet/
    mv $INPUT_DTI_OUTDIR/output/Output/Fernet/${INPUT_SUBJECT}/* $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Fernet/

    mkdir -p $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Output_Temp_Dir
    mv $INPUT_DTI_OUTDIR/output/Output/Output_Temp_Dir/* $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Output_Temp_Dir/
 
    mkdir -p $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/DTI_Preprocess
    mv $INPUT_DTI_OUTDIR/output/Output/DTI_Preprocess/${INPUT_SUBJECT}/* $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/DTI_Preprocess/

    mkdir -p $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Registration/Registration_DTI-Eve/
    mkdir -p $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Registration/Registration_DTI-T1/
    mkdir -p $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Registration/Registration_T1-Eve/
    mv $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_T1-Eve/${INPUT_SUBJECT}/Registration_T1-Eve/${INPUT_SUBJECT}/* $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Registration/Registration_T1-Eve/
    mv $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-T1/${INPUT_SUBJECT}/Registration_DTI-T1/${INPUT_SUBJECT}/* $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Registration/Registration_DTI-T1/
    mv $INPUT_DTI_OUTDIR/output/Output/Registration/Registration_DTI-Eve/${INPUT_SUBJECT}/* $INPUT_DTI_OUTDIR/${INPUT_SUBJECT}/Registration/Registration_DTI-Eve/

    rm -rf $INPUT_DTI_OUTDIR/output/

%labels

    Maintainer "Drew Parker <william.parker@pennmedicine.upenn.edu> and Sai Krishna Chaitanya Annavazala <SaiKrishna.Annavazala@pennmedicine.upenn.edu>"
    Version "1.0.0"

%test 
    /bin/bash -c 'echo "Container Test Successful, Please Run the Container"'
